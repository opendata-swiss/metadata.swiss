name: "[UI] Handle previews on PR"

on:
  pull_request:
    paths:
      - "opendata.swiss/ui/**" # Only trigger if files in the ui directory change
      - ".github/workflows/previews-ods-ui.yaml" # Trigger also if this workflow file is changed
      - ".github/workflows/docker-ods-ui.yaml" # Trigger also if the docker workflow file is changed

jobs:
  preview:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.33.0

      - name: Set up Kustomize
        uses: imranismail/setup-kustomize@v2

      - name: Configure some variables
        id: vars
        run: |
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "branch=${GITHUB_HEAD_REF:-${GITHUB_REF_NAME}}" >> $GITHUB_OUTPUT

      - name: Configure cluster context
        run: |
          kubectl config set-cluster default "--server=${K8S_API_URL}" --insecure-skip-tls-verify=true
          kubectl config set-credentials default "--token=${K8S_TOKEN}"
          kubectl config set-context default --cluster=default --namespace=piveau-previews --user=default
          kubectl config use-context default

      - name: Generate manifests
        working-directory: ./opendata.swiss/ui/k8s
        run: |
          kustomize edit set nameprefix "${{ steps.vars.outputs.branch }}-"
          kustomize edit add patch --patch "$(cat <<EOF
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: piveau-ui
          spec:
            tls:
              - secretName: ${{ steps.vars.outputs.branch }}-prev-tls
                hosts:
                  - ${{ steps.vars.outputs.branch }}.piveau-ln-preview.zazukoians.org
              rules:
                - host: ${{ steps.vars.outputs.branch }}.piveau-ln-preview.zazukoians.org
                  http:
                    paths:
                      - path: /
                        pathType: Prefix
                        backend:
                          service:
                            name: piveau-ui
                            port:
                              name: http
          EOF
          )"
          kustomize edit set image "ghcr.io/opendata-swiss/ods-ui=ghcr.io/opendata-swiss/ods-ui:sha-${{ steps.vars.outputs.short_sha }}"
          kustomize edit set label "app.kubernetes.io/instance:${{ steps.vars.outputs.branch }}"
          kustomize build | tee manifest.yaml
